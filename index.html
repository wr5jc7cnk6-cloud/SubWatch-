<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>SubWatch</title>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged,
createUserWithEmailAndPassword,
signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "API_KEY",
  authDomain: "PROJECT.firebaseapp.com",
  projectId: "PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let uid = "";

/* 年齢確認 */
if (!localStorage.getItem("ageOK")) {
  showModal("年齢確認", "13歳以上ですか？", [
    { text: "はい", action: () => {
      localStorage.setItem("ageOK", "true");
      closeModal();
      showNewFeature();
    }},
    { text: "いいえ", action: () => alert("利用できません") }
  ]);
} else if (!localStorage.getItem("newFeature")) {
  showNewFeature();
}

function showNewFeature() {
  showModal("新機能✨", "保存機能が搭載されました", [
    { text: "閉じる", action: () => {
      localStorage.setItem("newFeature", "true");
      closeModal();
    }}
  ]);
}

/* 認証 */
onAuthStateChanged(auth, user => {
  if (!user) return;
  uid = user.uid;
  loadSubs();
});

/* UI関数 */
window.signup = () => {
  createUserWithEmailAndPassword(auth, email.value, password.value)
    .catch(e => alert(e.message));
};

window.login = () => {
  signInWithEmailAndPassword(auth, email.value, password.value)
    .catch(e => alert(e.message));
};

/* サブスク */
window.addSub = async () => {
  if (!subName.value || !price.value) return;
  await addDoc(collection(db, "users", uid, "subs"), {
    name: subName.value,
    price: Number(price.value),
    date: new Date().toISOString().slice(0,10)
  });
  subName.value = "";
  price.value = "";
  loadSubs();
};

async function loadSubs() {
  list.innerHTML = "";
  let total = 0;
  const snap = await getDocs(collection(db, "users", uid, "subs"));
  snap.forEach(d => {
    const s = d.data();
    total += s.price;
    list.innerHTML += `
      <li>
        ${s.name} ¥${s.price}
        <small>次回: ${s.date}</small>
        <button onclick="deleteSub('${d.id}')">削除</button>
      </li>`;
  });
  monthly.textContent = `月額合計: ¥${total}`;
  yearly.textContent = `年額合計: ¥${total * 12}`;
}

window.deleteSub = async (id) => {
  await deleteDoc(doc(db, "users", uid, "subs", id));
  loadSubs();
};

/* モーダル */
window.showModal = (title, text, buttons) => {
  modal.style.display = "flex";
  modalBox.innerHTML = `<h2>${title}</h2><p>${text}</p>`;
  buttons.forEach(b => {
    const btn = document.createElement("button");
    btn.textContent = b.text;
    btn.onclick = b.action;
    modalBox.appendChild(btn);
  });
};

window.closeModal = () => modal.style.display = "none";
</script>

<style>
body { font-family: sans-serif; background:#f2f2f2; text-align:center; }
input,button { padding:10px; margin:5px; width:80%; max-width:300px; }
button { background:#007aff; color:#fff; border:none; border-radius:6px; }
ul { list-style:none; padding:0; }
li { background:#fff; margin:10px; padding:10px; border-radius:8px; }
small { display:block; color:#666; }
.modal {
  position:fixed; inset:0; background:rgba(0,0,0,.5);
  display:none; align-items:center; justify-content:center;
}
.modal-box {
  background:#fff; padding:20px; border-radius:10px;
  width:80%; max-width:300px;
}
</style>
</head>

<body>

<h1>SubWatch（サブウォッチ）</h1>

<h3>アカウント</h3>
<input id="email" placeholder="メール">
<input id="password" type="password" placeholder="パスワード">
<button onclick="signup()">新規登録</button>
<button onclick="login()">ログイン</button>

<hr>

<input id="subName" placeholder="サブスク名">
<input id="price" type="number" placeholder="月額料金（円）">
<button onclick="addSub()">追加</button>

<ul id="list"></ul>

<h3 id="monthly">月額合計: ¥0</h3>
<h3 id="yearly">年額合計: ¥0</h3>

<!-- モーダル -->
<div id="modal" class="modal">
  <div id="modalBox" class="modal-box"></div>
</div>

</body>
</html>
