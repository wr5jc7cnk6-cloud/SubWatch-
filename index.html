<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SubWatch</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f2f2;
  padding: 20px;
}
input, button {
  padding: 8px;
  margin: 6px 0;
  width: 100%;
}
.item { margin: 6px 0; }
.ban {
  text-align: center;
  margin-top: 60px;
}
.line-btn {
  display: inline-block;
  margin-top: 12px;
  padding: 10px;
  background: #06C755;
  color: #fff;
  text-decoration: none;
  border-radius: 6px;
}
.note {
  margin-top: 10px;
  font-size: 12px;
  color: #555;
}
</style>
</head>
<body>

<div id="app"></div>

<script>
/* ===== è¨­å®š ===== */
const PLAN = "normal"; // normal | lite | pro
const LIMITS = { normal: 3, lite: 5, pro: Infinity };
const ADMIN_PIN = "0823";
const MAX_WARN = 5;
const MAX_UNLOCK_FAIL = 3;
const LINE_URL = "https://line.me/R/ti/p/@254pdcli";

/* ===== çŠ¶æ…‹ ===== */
let items = JSON.parse(localStorage.getItem("items") || "[]");
let warnings = Number(localStorage.getItem("warnings") || 0);
let banned = localStorage.getItem("banned") === "true";
let unlockFails = Number(localStorage.getItem("unlockFails") || 0);
let permaBan = localStorage.getItem("permaBan") === "true";

/* ===== ä»Šæ—¥ã®è§£é™¤ç•ªå· ===== */
function todayUnlockCode() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `SUBWATCH-UNLOCK-${y}${m}${day}`;
}

/* ===== æç”» ===== */
function render() {
  const app = document.getElementById("app");
  app.innerHTML = "";

  /* æ°¸ä¹…åœæ­¢ */
  if (permaBan) {
    app.innerHTML = `
      <div class="ban">
        <h1>ğŸš« æ°¸ä¹…åœæ­¢ä¸­</h1>
        <p>ç®¡ç†äººPINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <input id="pin" placeholder="ç®¡ç†äººPIN">
        <button onclick="adminUnlock()">è§£é™¤</button>

        <a class="line-btn" href="${LINE_URL}" target="_blank">å…¬å¼LINEã¸</a>
        <div class="note">â€»ç”³ã—ç«‹ã¦ã¯1åº¦ã®ã¿ã”åˆ©ç”¨é ‚ã‘ã¾ã™</div>
      </div>
    `;
    return;
  }

  /* BAN */
  if (banned) {
    app.innerHTML = `
      <div class="ban">
        <h1>ğŸš« BANã•ã‚Œã¾ã—ãŸ</h1>
        <p>è§£é™¤ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <input id="code" placeholder="è§£é™¤ç•ªå·">
        <button onclick="unlock()">è§£é™¤</button>
        <p>å¤±æ•— ${unlockFails}/${MAX_UNLOCK_FAIL}</p>

        <a class="line-btn" href="${LINE_URL}" target="_blank">å…¬å¼LINEã¸</a>
        <div class="note">â€»ç”³ã—ç«‹ã¦ã¯1åº¦ã®ã¿ã”åˆ©ç”¨é ‚ã‘ã¾ã™</div>
      </div>
    `;
    return;
  }

  /* é€šå¸¸ç”»é¢ */
  app.innerHTML = `
    <h1>SubWatch</h1>
    <p>${PLAN}ç‰ˆ</p>

    <input id="name" placeholder="ã‚µãƒ¼ãƒ“ã‚¹å">
    <input id="price" placeholder="é‡‘é¡">
    <button onclick="addItem()">è¿½åŠ </button>

    <div id="list"></div>
  `;

  const list = document.getElementById("list");
  items.forEach(i => {
    const div = document.createElement("div");
    div.className = "item";
    div.textContent = `${i.name} / Â¥${i.price}`;
    list.appendChild(div);
  });
}

/* ===== è¿½åŠ  ===== */
function addItem() {
  if (items.length >= LIMITS[PLAN]) {
    warnings++;
    localStorage.setItem("warnings", warnings);

    if (warnings >= MAX_WARN) {
      banned = true;
      localStorage.setItem("banned", "true");
      render();
      return;
    }

    alert(`ç™»éŒ²ä¸Šé™ã§ã™ï¼ˆè­¦å‘Š ${warnings}/${MAX_WARN}ï¼‰`);
    return;
  }

  const name = document.getElementById("name").value;
  const price = document.getElementById("price").value;
  if (!name || !price) return;

  items.push({ name, price });
  localStorage.setItem("items", JSON.stringify(items));
  render();
}

/* ===== é€šå¸¸BANè§£é™¤ ===== */
function unlock() {
  const input = document.getElementById("code").value.trim();

  if (input === todayUnlockCode()) {
    banned = false;
    warnings = 0;
    unlockFails = 0;
    localStorage.removeItem("banned");
    localStorage.removeItem("warnings");
    localStorage.removeItem("unlockFails");
    render();
    return;
  }

  unlockFails++;
  localStorage.setItem("unlockFails", unlockFails);

  if (unlockFails >= MAX_UNLOCK_FAIL) {
    permaBan = true;
    localStorage.setItem("permaBan", "true");
    render();
    return;
  }

  alert("è§£é™¤ç•ªå·ãŒé•ã„ã¾ã™");
}

/* ===== æ°¸ä¹…åœæ­¢è§£é™¤ï¼ˆç®¡ç†äººPINï¼‰ ===== */
function adminUnlock() {
  const pin = document.getElementById("pin").value.trim();

  if (pin === ADMIN_PIN) {
    localStorage.clear();
    banned = false;
    permaBan = false;
    warnings = 0;
    unlockFails = 0;
    render();
  } else {
    alert("ç®¡ç†äººPINãŒé•ã„ã¾ã™");
  }
}

render();
</script>

</body>
</html>
